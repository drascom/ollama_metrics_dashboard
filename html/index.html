<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><title>Ollama Middleware</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0e0f12; --text:#d7dce2; --accent:#4ade80; --border:#232633; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    header { padding:14px; border-bottom:1px solid var(--border); background:#0c0e13; display:flex; justify-content:space-between; align-items:center; }
    input, button { background:#101217; border:1px solid var(--border); color:var(--text); padding:8px; border-radius:6px; }
    table { width:100%; border-collapse:collapse; font-size:13px; margin-top:10px; }
    th, td { padding:10px; text-align:left; border-bottom:1px solid var(--border); }
    tr.data-row:hover { background:rgba(255,255,255,0.05); cursor:pointer; }
    tr.details-row { display:none; background:rgba(0,0,0,0.3); }
    tr.details-row.open { display:table-row; }
    pre { white-space:pre-wrap; max-height:200px; overflow:auto; background:rgba(0,0,0,0.4); padding:10px; }
  </style>
</head>
<body>
  <header>
    <b>Ollama Metrics</b>
    <div style="display:flex;gap:10px">
      <input id="q" placeholder="Filter..." oninput="render()">
      <button onclick="clearLogs()" style="color:#ef4444">Clear</button>
      <button id="liveBtn" onclick="toggle()">Live</button>
    </div>
  </header>
  <div style="padding:15px">
    <table id="t"><thead><tr><th>Time</th><th>Model</th><th>Tokens</th><th>TPS</th><th>ms</th></tr></thead><tbody></tbody></table>
  </div>
  <script>
    let all=[], paused=false;
    const toggle=()=>{paused=!paused; document.getElementById("liveBtn").textContent=paused?"Paused":"Live";};
    const esc=s=>(s??"").toString().replaceAll("<","&lt;");
    const render=()=>{
      const q=document.getElementById("q").value.toLowerCase();
      const openSet=new Set();
      document.querySelectorAll('.open').forEach(r=>openSet.add(r.id));
      const rows=all.filter(x=>!q||JSON.stringify(x).toLowerCase().includes(q));
      document.querySelector("tbody").innerHTML=rows.map(x=>{
        let ts=x.ts.split("T")[1]||x.ts; 
        let rid=(x.rid||"").replace(/[^a-z0-9]/gi,"");
        let tpsC = Number(x.tps)>10?'#4ade80':'inherit';
        return `<tr class="data-row" onclick="document.getElementById('d-${rid}').classList.toggle('open')">
          <td style="color:#888">${ts}</td><td style="color:#4ade80">${esc(x.model)}</td>
          <td>${esc(x.completion)}</td><td style="color:${tpsC}">${esc(x.tps)}</td><td>${esc(x.ms)}</td>
        </tr>
        <tr class="details-row ${openSet.has('d-'+rid)?'open':''}" id="d-${rid}"><td colspan="5" style="padding:10px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
             <div><div style="color:#888">Prompt</div><pre>${esc(x.prompt)}</pre></div>
             <div><div style="color:#888">Response</div><pre>${esc(x.response)}</pre></div>
          </div>
        </td></tr>`
      }).join("");
    };
    const load=async()=>{
       if(paused)return;
       try{ 
         let r=await fetch("/metrics.json"); 
         if(r.ok){ all=(await r.json()).sort((a,b)=>a.ts<b.ts?1:-1); render(); }
       }catch(e){}
    };
    const clearLogs=async()=>{ if(confirm("Clear?")){ await fetch("/clear",{method:"POST"}); all=[]; render(); }};
    setInterval(load,1000); load();
  </script>
</body>
</html>
